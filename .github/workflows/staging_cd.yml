name: CD - Deploy to Staging

on:
  workflow_run:
    workflows: ["Frontend CI - Build & Push Image"]
    types:
      - completed

jobs:
  deploy_backend:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    uses: ./.github/workflows/backend_cd.yml
    with:
      aks_cluster_name: ${{ vars.AKS_CLUSTER_NAME }}
      aks_resource_group: ${{ vars.AKS_RESOURCE_GROUP }}
    secrets: inherit

  acceptance_tests:
    needs: deploy_backend
    runs-on: ubuntu-latest
    steps:
      - name: Health checks
        run: |
          echo "Product IP:  ${{ needs.deploy_backend.outputs.PRODUCT_IP }}"
          echo "Order IP:    ${{ needs.deploy_backend.outputs.ORDER_IP }}"
          echo "Customer IP: ${{ needs.deploy_backend.outputs.CUSTOMER_IP }}"
          curl --fail "http://${{ needs.deploy_backend.outputs.PRODUCT_IP }}:8000/health"
          curl --fail "http://${{ needs.deploy_backend.outputs.ORDER_IP }}:8001/health"
          curl --fail "http://${{ needs.deploy_backend.outputs.CUSTOMER_IP }}:8002/health"

  deploy_frontend:
    needs: acceptance_tests
    uses: ./.github/workflows/frontend_cd.yml
    with:
      product_api_url: http://${{ needs.deploy_backend.outputs.PRODUCT_IP }}:8000
      order_api_url: http://${{ needs.deploy_backend.outputs.ORDER_IP }}:8001
      customer_api_url: http://${{ needs.deploy_backend.outputs.CUSTOMER_IP }}:8002
    secrets: inherit
